<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Perception & Memory Visualization</title>
    <style>
      body {
        font-family: "Courier New", Courier, monospace;
        background: #f9f9f9;
        margin: 0;
        padding: 20px;
        line-height: 1.5;
      }
      h1,
      h2 {
        color: #333;
        margin: 0 0 10px;
        font-weight: normal;
      }
      .section {
        margin-bottom: 20px;
        background: #fff;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      }
      .section pre {
        background: #eef;
        padding: 10px;
        border: 1px solid #ccd;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .memory {
        background: #e7f3fe;
        border-left: 5px solid #2196F3;
        margin: 5px 0;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
      }
      .memory:hover {
        background: #d0e7fc;
      }
      .memory-details {
        display: none;
        margin-top: 5px;
        font-size: 0.9em;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h1>Perception & Memory Visualization</h1>

    <div class="section" id="thought">
      <h2>Internal Thought</h2>
      <div id="thoughtContent">Loading internal thought...</div>
    </div>

    <div class="section" id="identity">
      <h2>Identity</h2>
      <div id="identityContent">Loading identity...</div>
    </div>

    <div class="section" id="memory">
      <h2>Influencing Memories</h2>
      <div id="memoryContent">Loading relevant memories...</div>
    </div>

    <div class="section" id="perception">
      <h2>Perception</h2>
      <div id="perceptionContent">Loading perception state...</div>
    </div>

    <script>
      // Function to fetch data from an API endpoint with error handling.
      async function fetchData(url, body = null) {
        try {
          const options = {
            method: body ? "POST" : "GET",
            headers: { "Content-Type": "application/json" }
          };
          if (body) {
            options.body = JSON.stringify(body);
          }
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error(`Error fetching ${url}:`, error);
          return { error: error.message };
        }
      }

      // Toggle the display of detailed memory information when a memory div is clicked.
      function toggleMemoryDetail(element) {
        const detailElem = element.querySelector(".memory-details");
        if (detailElem) {
          detailElem.style.display =
            detailElem.style.display === "none" ? "block" : "none";
        }
      }

      // Update all sections by fetching data from the server.
      async function updateSection() {
        // Fetch the current thought.
        const thoughtData = await fetchData("/api/thought");
        const thoughtElem = document.getElementById("thoughtContent");
        if (thoughtData.error) {
          thoughtElem.innerHTML = `<pre>Error: ${thoughtData.error}</pre>`;
        } else {
          thoughtElem.innerHTML = `<pre>${
            thoughtData.current || "No current thought available."
          }</pre>`;
        }

        // Fetch the identity data.
        const identityData = await fetchData("/api/identity");
        const identityElem = document.getElementById("identityContent");
        if (identityData.error) {
          identityElem.innerHTML = `<pre>Error: ${identityData.error}</pre>`;
        } else {
          identityElem.innerHTML = `<pre>${JSON.stringify(
            identityData,
            null,
            2
          )}</pre>`;
        }

        // Fetch the perception and memory influences.
        // Use GET; if your endpoint requires context, adjust the API accordingly.
        const perceptionData = await fetchData("/api/perception");
        const perceptionElem = document.getElementById("perceptionContent");
        const memoryContentElem = document.getElementById("memoryContent");

        if (perceptionData.error) {
          perceptionElem.innerHTML = `<pre>Error: ${perceptionData.error}</pre>`;
          memoryContentElem.innerHTML =
            '<div class="memory">Error loading memory influences.</div>';
        } else {
          perceptionElem.innerHTML = `<pre>${JSON.stringify(
            perceptionData.perception,
            null,
            2
          )}</pre>`;

          let memoryHtml = "";
          if (
            perceptionData.memoriesInfluencingPerception &&
            perceptionData.memoriesInfluencingPerception.length > 0
          ) {
            perceptionData.memoriesInfluencingPerception.forEach((mem) => {
              // Assume each memory is either a string or an object with
              // "content" and "detail" properties.
              const summary = typeof mem === "string" ? mem : mem.content;
              const detail =
                typeof mem === "string" ? "No additional details." : mem.detail;
              memoryHtml += `
                <div class="memory" onclick="toggleMemoryDetail(this)" title="Click to toggle details">
                  ${summary}
                  <div class="memory-details">${detail}</div>
                </div>`;
            });
          } else {
            memoryHtml =
              '<div class="memory">No significant memories influencing perception.</div>';
          }
          memoryContentElem.innerHTML = memoryHtml;
        }
      }

      // Initial load and periodic update every 5 seconds.
      updateSection();
      setInterval(updateSection, 5000);
    </script>
  </body>
</html>
